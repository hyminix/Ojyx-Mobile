#!/bin/bash

# Pre-commit hook pour Ojyx - Enforcement TDD
# Ce script vÃ©rifie le respect des rÃ¨gles TDD avant chaque commit

echo "ðŸ” VÃ©rification du respect des rÃ¨gles TDD..."

# Couleurs pour l'output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Compteur d'erreurs
ERRORS=0

# 1. VÃ©rifier les tests commentÃ©s
echo -n "Recherche de tests commentÃ©s... "
COMMENTED_TESTS=$(grep -rn "//.*test\(\|/\*.*test\|skip:\s*true\|\.skip(\|xit(\|xtest(\|pending(" --include="*.dart" lib/ test/ 2>/dev/null || true)

if [ ! -z "$COMMENTED_TESTS" ]; then
    echo -e "${RED}âŒ${NC}"
    echo -e "${RED}Tests commentÃ©s dÃ©tectÃ©s:${NC}"
    echo "$COMMENTED_TESTS"
    ((ERRORS++))
else
    echo -e "${GREEN}âœ…${NC}"
fi

# 2. VÃ©rifier les fichiers test_summary
echo -n "Recherche de fichiers test_summary interdits... "
SUMMARY_FILES=$(find . -type f \( -name "*test*summary*" -o -name "*TEST*SUMMARY*" \) -not -path "./.git/*" 2>/dev/null || true)

if [ ! -z "$SUMMARY_FILES" ]; then
    echo -e "${RED}âŒ${NC}"
    echo -e "${RED}Fichiers test_summary dÃ©tectÃ©s:${NC}"
    echo "$SUMMARY_FILES"
    ((ERRORS++))
else
    echo -e "${GREEN}âœ…${NC}"
fi

# 3. VÃ©rifier que chaque fichier .dart a un test correspondant
echo -n "VÃ©rification de la prÃ©sence de tests pour tous les fichiers... "
MISSING_TESTS=""

for file in $(find lib/ -name "*.dart" -not -path "*/generated/*" -not -path "*/*.g.dart" -not -path "*/*.freezed.dart" -not -name "main.dart" 2>/dev/null || true); do
    TEST_FILE=$(echo "$file" | sed 's|^lib/|test/|' | sed 's|\.dart$|_test.dart|')
    ALT_TEST_FILE=$(echo "$file" | sed 's|^lib/|test/|')
    
    if [ ! -f "$TEST_FILE" ] && [ ! -f "$ALT_TEST_FILE" ]; then
        MISSING_TESTS="${MISSING_TESTS}\n  - $file"
    fi
done

if [ ! -z "$MISSING_TESTS" ]; then
    echo -e "${RED}âŒ${NC}"
    echo -e "${RED}Fichiers sans tests:${NC}"
    echo -e "$MISSING_TESTS"
    ((ERRORS++))
else
    echo -e "${GREEN}âœ…${NC}"
fi

# 4. VÃ©rifier que les fichiers de test contiennent des tests rÃ©els
echo -n "Validation du contenu des fichiers de test... "
EMPTY_TESTS=""

for test_file in $(find test/ -name "*_test.dart" 2>/dev/null || true); do
    if ! grep -q -E "(test\(|testWidgets\(|group\()" "$test_file"; then
        EMPTY_TESTS="${EMPTY_TESTS}\n  - $test_file"
    fi
done

if [ ! -z "$EMPTY_TESTS" ]; then
    echo -e "${RED}âŒ${NC}"
    echo -e "${RED}Fichiers de test vides ou invalides:${NC}"
    echo -e "$EMPTY_TESTS"
    ((ERRORS++))
else
    echo -e "${GREEN}âœ…${NC}"
fi

# 5. VÃ©rifier la prÃ©sence de patterns TODO/FIXME dans les tests
echo -n "Recherche de tests incomplets (TODO/FIXME)... "
INCOMPLETE_TESTS=$(grep -rn "TODO.*test\|FIXME.*test\|skip(\|skipTest" --include="*_test.dart" test/ 2>/dev/null || true)

if [ ! -z "$INCOMPLETE_TESTS" ]; then
    echo -e "${YELLOW}âš ï¸${NC}"
    echo -e "${YELLOW}Tests incomplets dÃ©tectÃ©s (warning):${NC}"
    echo "$INCOMPLETE_TESTS"
fi

# 6. ExÃ©cuter les tests Flutter
echo "ExÃ©cution des tests Flutter..."
if ! flutter test --reporter=compact; then
    echo -e "${RED}âŒ Des tests Ã©chouent!${NC}"
    ((ERRORS++))
else
    echo -e "${GREEN}âœ… Tous les tests passent${NC}"
fi

# 7. VÃ©rifier la couverture de code
echo -n "VÃ©rification de la couverture de code... "
flutter test --coverage > /dev/null 2>&1
if [ -f "coverage/lcov.info" ]; then
    COVERAGE=$(lcov --summary coverage/lcov.info 2>/dev/null | grep "lines" | grep -o '[0-9.]\+%' | head -1 | sed 's/%//')
    if [ ! -z "$COVERAGE" ]; then
        if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo -e "${RED}âŒ${NC}"
            echo -e "${RED}Couverture insuffisante: ${COVERAGE}% (minimum requis: 80%)${NC}"
            ((ERRORS++))
        else
            echo -e "${GREEN}âœ… ${COVERAGE}%${NC}"
        fi
    fi
fi

# RÃ©sultat final
echo ""
if [ $ERRORS -gt 0 ]; then
    echo -e "${RED}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${RED}âŒ COMMIT REFUSÃ‰: $ERRORS violation(s) TDD dÃ©tectÃ©e(s)${NC}"
    echo -e "${RED}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "ðŸ“– Consultez CLAUDE.md pour les rÃ¨gles TDD complÃ¨tes."
    echo "ðŸ’¡ Rappel: Ã‰crivez TOUJOURS les tests AVANT le code!"
    echo ""
    exit 1
else
    echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${GREEN}âœ… Toutes les vÃ©rifications TDD passent!${NC}"
    echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
fi

exit 0